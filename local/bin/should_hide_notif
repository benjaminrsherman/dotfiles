#!/usr/bin/python3

# Simple script to decide whether or not to hide a Discord notification.  If I'm in partial-DND,
# i.e. I'm focusing on something but want to be interrupted for important notifications, this will
# hide all non-direct notifications.  This is accomplished by parsing the notification header to
# determine the source of the notification.
#
# Discord notification headers are of the following form:
#   - `Username`: this occurs when a direct message is received. `Username` is the username of the
#                 user which sent the message.
#   - `Username (Group name)`: this occurs when a group message is received.  `Username` is the
#                              username of the user which sent the message, and `Group name` is the
#                              name of the group in which the message was sent.
#   - `Username (#channel[, category])`: this occurs when a message from a server is received.  As
#                                        before, `Username` is the user which sent the message.
#                                        `channel` is the name of the channel in which the message
#                                        was sent, and if that channel is in a channel category
#                                        then `category` is the name of that category.
#
# This format means that all server messages will match the following regex: r"^.+ \(#.+\)$". Some
# false positives will be caught (most commonly, groups whose name begins with a hash), but it is
# impossible to detect these false positives.

import os
import re
import sys

try:
    with open("/tmp/dnd_level") as f:
        dnd_level = int(f.readline())
except FileNotFoundError:
    # /tmp/dnd_level doesn't exist, so we're not in dnd
    dnd_level = 0

if dnd_level == 0:
    # Not in dnd, so don't hide anything
    sys.exit(0)
elif dnd_level == 1:
    # In partial dnd, do some filtering
    appname = sys.argv[1]

    if appname == "discord":
        notif_header = sys.argv[2]

        if re.match(r"^.+ \(#.+\)$", notif_header) is None:
            # Not a server message, don't hide this
            sys.exit(0)
        else:
            # This is a server message, hide it
            sys.exit(1)

    sys.exit(0)
else:
    # in full dnd, hide everything
    sys.exit(1)
